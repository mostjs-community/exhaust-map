(function(global,factory){typeof exports==="object"&&typeof module!=="undefined"?factory(exports,require("@most/disposable"),require("@most/prelude"),require("@most/scheduler")):typeof define==="function"&&define.amd?define(["exports","@most/disposable","@most/prelude","@most/scheduler"],factory):factory(global["most-exhaust-map"]={},global.disposable,global.prelude,global.scheduler)})(this,function(exports,disposable,prelude,scheduler){"use strict";var exhaustMap=prelude.curry2(_exhaustMap);function _exhaustMap(fn,stream){return new ExhaustMap(fn,stream)}var ExhaustMap=function(){function ExhaustMap(fn,source){this.fn=fn;this.source=source}ExhaustMap.prototype.run=function(sink,scheduler$$1){var exhaustMapSink=new ExhaustMapSink(this.fn,sink,scheduler$$1);return disposable.disposeBoth(exhaustMapSink,this.source.run(exhaustMapSink,scheduler$$1))};return ExhaustMap}();var ExhaustMapSink=function(){function ExhaustMapSink(fn,sink,scheduler$$1){this.fn=fn;this.sink=sink;this.scheduler=scheduler$$1;this.ended=false}ExhaustMapSink.prototype.event=function(t,value){if(this.current===undefined){var segment=new Segment(t,this,this.sink);this.current=this.fn(value).run(segment,scheduler.schedulerRelativeTo(t,this.scheduler))}};ExhaustMapSink.prototype.end=function(t){this.ended=true;this._checkEnd(t)};ExhaustMapSink.prototype.error=function(t,error){this.ended=true;this.sink.error(t,error)};ExhaustMapSink.prototype.dispose=function(){this._disposeCurrent(scheduler.currentTime(this.scheduler))};ExhaustMapSink.prototype._disposeCurrent=function(t){if(this.current!==undefined){disposable.tryDispose(t,this.current,this.sink);this.current=undefined}};ExhaustMapSink.prototype._endInner=function(t){this._disposeCurrent(t);this._checkEnd(t)};ExhaustMapSink.prototype._errorInner=function(t,error){this._disposeCurrent(t);this.sink.error(t,error)};ExhaustMapSink.prototype._checkEnd=function(t){if(this.ended&&this.current===undefined){this.sink.end(t)}};return ExhaustMapSink}();var Segment=function(){function Segment(time,outer,sink){this.time=time;this.outer=outer;this.sink=sink}Segment.prototype.event=function(t,value){this.sink.event(t+this.time,value)};Segment.prototype.end=function(t){this.outer._endInner(t+this.time)};Segment.prototype.error=function(t,error){this.outer._errorInner(t+this.time,error)};return Segment}();exports.exhaustMap=exhaustMap;Object.defineProperty(exports,"__esModule",{value:true})});